# ================================================================
# Codemagic CI/CD Configuration for Koya Score (ScoreCard)
# ================================================================
# Project: Card game score tracking app (Tiáº¿n LÃªn, Sáº¯c TÃª)
# Tech Stack: React Native (Expo), TypeScript, SQLite
# Platform: Android & iOS
# ================================================================

workflows:
  # ================================================================
  # ANDROID BUILD WORKFLOW
  # ================================================================
  android-workflow:
    name: Android Build & Release
    max_build_duration: 60
    instance_type: mac_mini_m1
    
    environment:
      # groups:
        # Add these environment variable groups in Codemagic UI when needed:
        # - google_play (GCLOUD_SERVICE_ACCOUNT_CREDENTIALS)
        # - expo (EXPO_TOKEN)
      vars:
        PACKAGE_NAME: "com.tienlen.scorecard"
        NODE_VERSION: "20"
      node: $NODE_VERSION
      
    triggering:
      events:
        - push
        - tag
        - pull_request
      branch_patterns:
        - pattern: 'main'
          include: true
          source: true
        - pattern: 'develop'
          include: true
          source: true
      tag_patterns:
        - pattern: 'v*'
          include: true
      cancel_previous_builds: true
      
    scripts:
      - name: ðŸ“¦ Install dependencies
        script: |
          echo "Installing Node.js dependencies..."
          npm install
          
      - name: ðŸ” Run TypeScript check
        script: |
          echo "Running TypeScript type checking..."
          npx tsc --noEmit
          
      - name: ðŸ—ï¸ Build Android APK/AAB
        script: |
          echo "Building Android app with Expo..."
          
          # Install EAS CLI globally
          npm install -g eas-cli
          
          # Build Android APK using EAS Build
          # Note: This requires EAS account and EXPO_TOKEN environment variable
          eas build --platform android --profile preview --non-interactive
          
          # Alternative: Build locally (requires Android SDK)
          # npx expo prebuild --platform android
          # cd android && ./gradlew assembleRelease
          
      - name: ðŸ“Š Generate build info
        script: |
          echo "Build completed at $(date)"
          echo "Package: $PACKAGE_NAME"
          echo "Version: $(node -p "require('./app.json').expo.version")"
          
    artifacts:
      - android/app/build/outputs/**/*.apk
      - android/app/build/outputs/**/*.aab
      - build-*.tar.gz
      
    publishing:
      email:
        recipients:
          - huynhvikhang6a13@gmail.com
        notify:
          success: true
          failure: true
          
      # Uncomment to publish to Google Play
      # google_play:
      #   credentials: $GCLOUD_SERVICE_ACCOUNT_CREDENTIALS
      #   track: internal
      #   submit_as_draft: true

  # ================================================================
  # iOS BUILD WORKFLOW
  # ================================================================
  ios-workflow:
    name: iOS Build & Release
    max_build_duration: 60
    instance_type: mac_mini_m1
    
    environment:
      # groups:
        # Add these environment variable groups in Codemagic UI when needed:
        # - app_store_connect (APP_STORE_CONNECT_KEY_IDENTIFIER, etc.)
        # - expo (EXPO_TOKEN)
        # - ios_certificate (CERTIFICATE_PRIVATE_KEY, etc.)
      vars:
        BUNDLE_ID: "com.tienlen.scorecard"
        XCODE_WORKSPACE: "ios/KoyaScore.xcworkspace"
        XCODE_SCHEME: "KoyaScore"
        NODE_VERSION: "20"
      node: $NODE_VERSION
      xcode: latest
      cocoapods: default
      
    triggering:
      events:
        - push
        - tag
      branch_patterns:
        - pattern: 'main'
          include: true
          source: true
      tag_patterns:
        - pattern: 'v*'
          include: true
      cancel_previous_builds: true
      
    scripts:
      - name: ðŸ“¦ Install dependencies
        script: |
          echo "Installing Node.js dependencies..."
          npm install
          
      - name: ðŸŽ Install CocoaPods dependencies
        script: |
          cd ios
          pod install
          
      - name: ðŸ” Run TypeScript check
        script: |
          echo "Running TypeScript type checking..."
          npx tsc --noEmit
          
      - name: ðŸ—ï¸ Build iOS IPA
        script: |
          echo "Building iOS app with Expo..."
          
          # Install EAS CLI globally
          npm install -g eas-cli
          
          # Build iOS IPA using EAS Build
          # Note: This requires EAS account and EXPO_TOKEN environment variable
          eas build --platform ios --profile preview --non-interactive
          
          # Alternative: Build locally (requires Xcode)
          # npx expo prebuild --platform ios
          # cd ios && xcodebuild -workspace KoyaScore.xcworkspace -scheme KoyaScore archive
          
      - name: ðŸ“Š Generate build info
        script: |
          echo "Build completed at $(date)"
          echo "Bundle ID: $BUNDLE_ID"
          echo "Version: $(node -p "require('./app.json').expo.version")"
          
    artifacts:
      - build/ios/ipa/*.ipa
      - /tmp/xcodebuild_logs/*.log
      - build-*.tar.gz
      
    publishing:
      email:
        recipients:
          - huynhvikhang6a13@gmail.com
        notify:
          success: true
          failure: true
          
      # Uncomment to publish to App Store
      # app_store_connect:
      #   auth: integration
      #   submit_to_testflight: true
      #   beta_groups:
      #     - Beta Testers
      #   submit_to_app_store: false

  # ================================================================
  # DEVELOPMENT BUILD (Debug APK for testing)
  # ================================================================
  dev-build:
    name: Development Build (Debug)
    max_build_duration: 30
    instance_type: mac_mini_m1
    
    environment:
      vars:
        NODE_VERSION: "20"
      node: $NODE_VERSION
      
    triggering:
      events:
        - push
      branch_patterns:
        - pattern: 'develop'
          include: true
          source: true
        - pattern: 'feature/*'
          include: true
          source: true
      cancel_previous_builds: true
      
    scripts:
      - name: ðŸ“¦ Install dependencies
        script: |
          npm install
          
      - name: ðŸ” Type check
        script: |
          npx tsc --noEmit
          
      - name: ðŸ—ï¸ Build debug APK
        script: |
          echo "Building debug APK..."
          
          # Install EAS CLI
          npm install -g eas-cli
          
          # Build development APK
          eas build --platform android --profile development --non-interactive
          
    artifacts:
      - android/app/build/outputs/**/*.apk
      
    publishing:
      email:
        recipients:
          - huynhvikhang6a13@gmail.com
        notify:
          success: false
          failure: true

  # ================================================================
  # QUALITY ASSURANCE WORKFLOW
  # ================================================================
  qa-workflow:
    name: Quality Assurance & Tests
    max_build_duration: 20
    instance_type: mac_mini_m1
    
    environment:
      vars:
        NODE_VERSION: "20"
      node: $NODE_VERSION
      
    triggering:
      events:
        - pull_request
      cancel_previous_builds: true
      
    scripts:
      - name: ðŸ“¦ Install dependencies
        script: |
          npm install
          
      - name: ðŸ” TypeScript type checking
        script: |
          echo "Running TypeScript compiler..."
          npx tsc --noEmit
          
      - name: ðŸ“ Code quality checks
        script: |
          echo "Checking code quality..."
          # Add ESLint if configured:
          # npm run lint
          
      - name: ðŸ§ª Run tests (if available)
        script: |
          echo "Running tests..."
          # Add when tests are implemented:
          # npm test
          
      - name: ðŸ“Š Build verification
        script: |
          echo "Verifying build can complete..."
          # Just verify that expo can prebuild without errors
          npx expo prebuild --no-install
          
    publishing:
      email:
        recipients:
          - huynhvikhang6a13@gmail.com
        notify:
          success: false
          failure: true

# ================================================================
# CONFIGURATION NOTES
# ================================================================
# 
# 1. ENVIRONMENT VARIABLES TO SET IN CODEMAGIC UI:
#    
#    A. EXPO_TOKEN (REQUIRED for builds):
#       - Go to https://expo.dev/accounts/[your-account]/settings/access-tokens
#       - Create a new token with "Read and write" permissions
#       - In Codemagic UI: Environment variables > Add variable
#       - Name: EXPO_TOKEN
#       - Value: [paste your token]
#       - Make it a secret variable
#    
#    B. For Google Play publishing (optional):
#       - GCLOUD_SERVICE_ACCOUNT_CREDENTIALS
#    
#    C. For App Store publishing (optional):
#       - APP_STORE_CONNECT_KEY_IDENTIFIER
#       - APP_STORE_CONNECT_ISSUER_ID
#       - APP_STORE_CONNECT_PRIVATE_KEY
#
# 2. REQUIRED SETUP:
#    
#    A. EAS Account Setup:
#       - Sign up at https://expo.dev
#       - Link your project: `eas init --id af01253e-afef-4bb5-9ff4-9a407733cf46`
#       - Configure eas.json (already exists in project)
#    
#    B. Signing Certificates:
#       - Android: EAS will auto-generate or you can upload your keystore
#       - iOS: Configure in Apple Developer account
#    
#    C. First Time Setup:
#       - Run locally first: `eas build --platform android --profile preview`
#       - This will set up credentials
#       - Then Codemagic can use the same credentials
#
# 3. BUILD TRIGGERS:
#    - Push to 'main' or 'develop': Full build
#    - Push to 'feature/*': Dev build only
#    - Tag 'v*': Release build
#    - Pull request: QA checks only
#
# 4. CUSTOMIZATION:
#    - Update email recipients
#    - Adjust build timeouts
#    - Configure publishing settings
#    - Add custom scripts as needed
#
# 5. EXPO/EAS INTEGRATION:
#    - This config uses EAS Build (cloud builds)
#    - Builds are done on Expo's servers
#    - Requires EXPO_TOKEN environment variable
#    - Build profiles defined in eas.json:
#      * development: Dev client APK
#      * preview: Internal testing APK
#      * production: App Bundle (AAB) for stores
#
# 6. TROUBLESHOOTING:
#    
#    Error: "Invalid project root"
#    - Fixed! Now using correct EAS build commands
#    
#    Error: "EXPO_TOKEN not found"
#    - Add EXPO_TOKEN in Codemagic environment variables
#    
#    Error: "No credentials configured"
#    - Run `eas build` locally first to set up credentials
#    
#    Build takes too long:
#    - EAS builds typically take 10-20 minutes
#    - Adjust max_build_duration if needed
#

# ================================================================
# PROJECT SPECIFIC NOTES
# ================================================================
# 
# App Name: Koya Score
# Package: com.tienlen.scorecard
# Version: 1.0.4
# 
# Features:
# - Card game score tracking (Tiáº¿n LÃªn, Sáº¯c TÃª)
# - SQLite database
# - Multi-language support (i18n)
# - Dark mode
# - Audio/Video support
# 
# Dependencies:
# - Expo SDK 54
# - React Native 0.81.5
# - TypeScript 5.9.2
# - React Navigation 7
# - expo-sqlite, expo-audio, expo-video
#
# ================================================================
